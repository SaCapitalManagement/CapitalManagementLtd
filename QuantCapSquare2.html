<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>New MR 2025 vs SPY Benchmark</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      margin: 0;
      padding: 0;
      line-height: 1.6;
      overflow-x: hidden;
      width: 100%;
      height: auto;
      box-sizing: border-box;
    }

    .dashboard-container {
      width: 100% !important;
      max-width: none !important;
      margin: 0 !important;
      padding: 8px !important;
      box-sizing: border-box !important;
    }

    .chart-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      margin-bottom: 12px;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    .stats-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    .extended-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      margin-top: 12px;
      border-top: 2px solid #e2e8f0;
      position: relative;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    .monthly-table-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      margin-top: 12px;
      width: 100% !important;
      box-sizing: border-box !important;
      overflow-x: auto;
    }

    .correlation-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 12px;
      margin-top: 12px;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    .extended-section::before {
      content: '';
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      border-radius: 2px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 16px;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 14px;
    }

    .main-layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stats-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chart-container {
      width: 100% !important;
      aspect-ratio: 1/1 !important;
      height: auto !important;
      overflow: hidden !important;
      box-sizing: border-box !important;
    }

    .correlation-chart-container {
      width: 100% !important;
      height: 400px !important;
      margin-top: 10px;
    }

    .correlation-axis-label {
      cursor: pointer;
      color: #0066CC;
      text-decoration: underline;
    }

    .correlation-axis-label:hover {
      color: #004499;
    }

    /* Desktop layout - side by side */
    @media (min-width: 768px) {
      .main-layout {
        display: flex;
        flex-direction: row;
        gap: 16px;
        align-items: flex-start;
      }

      .chart-section {
        flex: 1;
        max-width: 50%;
      }

      .stats-column {
        flex: 1;
        max-width: 50%;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      width: 100% !important;
    }

    .stat-item {
      padding: 16px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .stat-label {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: #64748b;
    }

    /* Monthly table styles - exact match to image */
    .monthly-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 10px;
      font-family: Arial, sans-serif;
    }

    .monthly-table th,
    .monthly-table td {
      padding: 6px 8px;
      text-align: center;
      border: none;
      font-weight: normal;
    }

    .monthly-table th {
      background-color: #ddffdd;
      font-weight: bold !important;
      color: #000;
      font-size: 11px;
    }

    .monthly-table .year-column {
      font-weight: bold;
      color: #000;
    }

    .monthly-table .total-column {
      font-weight: bold !important;
      color: #000;
    }

    .monthly-table .maxdd-column {
      font-weight: normal;
      color: #000;
    }

    /* Row alternating colors */
    .monthly-table tr:nth-child(even) {
      background-color: #f0f0f0;
    }

    .monthly-table tr:nth-child(odd) {
      background-color: #ffffff;
    }

    /* Performance color coding - exact match to image */
    .gain-positive {
      background-color: inherit !important;
      color: #000 !important;
    }

    .gain-negative {
      background-color: inherit !important;
      color: #ff0000 !important;
    }

    .gain-neutral {
      background-color: inherit !important;
      color: #000 !important;
    }

    /* AVG row styling */
    .monthly-table .avg-row {
      background-color: #ddffdd !important;
      font-weight: bold;
    }

    .monthly-table .avg-row td {
      background-color: #ddffdd !important;
      font-weight: bold !important;
      color: #000 !important;
    }

    /* Shopify embed optimizations */
    @media (max-width: 767px) {
      .main-layout {
        flex-direction: column !important;
      }

      .chart-section,
      .stats-column {
        max-width: 100% !important;
      }

      .dashboard-container {
        padding: 4px !important;
      }
      
      .chart-section,
      .stats-section,
      .extended-section,
      .monthly-table-section,
      .correlation-section {
        padding: 8px !important;
        margin-bottom: 8px !important;
      }
      
      .chart-container {
        width: 70% !important;
        aspect-ratio: 1/1 !important;
        height: auto !important;
        margin: 0 auto !important;
      }
      
      .stats-grid {
        grid-template-columns: 1fr !important;
        gap: 6px !important;
      }
      
      .stat-item {
        padding: 6px !important;
        font-size: 12px !important;
      }
      
      .stat-label {
        font-size: 11px !important;
      }
      
      .stat-value {
        font-size: 14px !important;
      }
      
      .section-title {
        font-size: 12px !important;
        margin-bottom: 8px !important;
      }

      .monthly-table {
        font-size: 9px;
        width: 100%;
        min-width: 100%;
      }

      .monthly-table th,
      .monthly-table td {
        padding: 3px 1px;
        font-size: 8px;
        line-height: 1.2;
        border: none;
      }

      .monthly-table th {
        font-weight: bold !important;
      }

      .monthly-table-section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 4px !important;
      }

      .correlation-chart-container {
        height: 250px !important;
      }
    }

    /* Very small containers (Shopify widgets) */
    @media (max-width: 400px) {
      .dashboard-container {
        padding: 2px !important;
      }
      
      .chart-section,
      .stats-section,
      .extended-section,
      .monthly-table-section,
      .correlation-section {
        padding: 6px !important;
        margin-bottom: 6px !important;
      }
      
      .chart-container {
        width: 80% !important;
        aspect-ratio: 1/1 !important;
        height: auto !important;
        margin: 0 auto !important;
      }
      
      .stats-grid {
        grid-template-columns: 1fr !important;
        gap: 4px !important;
      }

      .monthly-table {
        font-size: 8px;
        width: 100%;
        min-width: 600px;
      }

      .monthly-table th,
      .monthly-table td {
        padding: 2px 1px;
        font-size: 7px;
        line-height: 1.1;
        border: none;
      }

      .monthly-table th {
        font-weight: bold !important;
      }

      .monthly-table-section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 2px !important;
      }

      .correlation-chart-container {
        height: 200px !important;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="main-layout">
      <div class="chart-section">
        <div class="chart-container">
          <div id="newmrChart" style="width: 100%; height: 100%;"></div>
        </div>
      </div>

      <div class="stats-column">
        <div class="stats-section">
          <div id="statsPanel">
            <div class="loading">Loading statistics...</div>
          </div>
        </div>

        <div class="extended-section">
          <div class="section-title">Trading Details</div>
          <div id="extendedPanel">
            <div class="loading">Loading extended data...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Monthly Performance Table Section -->
    <div class="monthly-table-section">
      <div class="section-title">Combined Monthly Percent Gains</div>
      <div id="monthlyTablePanel">
        <div class="loading">Loading monthly performance data...</div>
      </div>
    </div>

    <!-- Correlation Analysis Section -->
    <div class="correlation-section">
      <div class="section-title">Correlation Analysis</div>
      <div id="correlationPanel">
        <div class="loading">Loading correlation data...</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <script>
    // Helper to extract product handle from the iframe URL query string
    function getProductHandle() {
      const params = new URLSearchParams(window.location.search);
      return params.get('handle');
    }

    // Mapping from product handle to their respective data URLs
    const handleDataMap = {
      'weekly-pullback-strategy': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/weeklydip.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/weeklydipt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/weeklydipx.json',
      },
      'low-drawdown-nasdaq-mean-reversion-strategy': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/ndxmr.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/ndxmrt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/ndxmrx.json',
      },
      'all-time-high-mean-reversion-strategy': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/athmr.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/athmrt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/athmrx.json',
      },
      'etf-rotate-monthly-rebalance-investing-strategy': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/etfrotation.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/etfrotationt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/etfrotationx.json',
      },
      'mean-reversion-trading-strategy-for-2025': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/newmr2025.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/newmr2025t_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/newmr2025x.json',
      },
      'modern-breakout-strategy': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/breakout.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/breakoutt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/breakoutx.json',
      },
      'nasdaq-100-mean-reversion-strategy': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/nasdaq_mr.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/nasdaq_mrt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/nasdaq_mrx.json',
      },
      'parabolic-short-selling-strategy': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/shortsellmr.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/shortsellmrt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/shortsellmrx.json',
      },
      'short-term-mean-reversion-strategy': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/shorttermmr.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/shorttermmrt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/shorttermmr.json',
      },
      'spy-mean-reversion': {
        newmrUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/spxmr.json',
        spyUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json',
        statsUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/spxmrxt_stats.json',
        extendedUrl: 'https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/spxmrx.json',
      },
      // Add more products as needed
    };

    // Default URLs (current ones)
    const defaultUrls = {
      newmrUrl: "https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/newmr2025.json",
      spyUrl: "https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/main/public_json/spybenchmark.json",
      statsUrl: "https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/newmr2025t_stats.json",
      extendedUrl: "https://raw.githubusercontent.com/SaCapitalManagement/CapitalManagementLtd/refs/heads/main/public_json/newmr2025x.json"
    };

    // Get the URLs for the current product handle
    const productHandle = getProductHandle();
    const currentUrls = handleDataMap[productHandle] || defaultUrls;

    async function fetchJsonOrLog(url, label) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
        return await res.json();
      } catch (e) {
        console.error(`Error fetching ${label} from ${url}:`, e);
        throw e;
      }
    }

    // Function to calculate correlation coefficient
    function calculateCorrelation(x, y) {
      const n = x.length;
      if (n !== y.length || n === 0) return 0;
      
      const sumX = x.reduce((a, b) => a + b, 0);
      const sumY = y.reduce((a, b) => a + b, 0);
      const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
      const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
      const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
      
      const numerator = n * sumXY - sumX * sumY;
      const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
      
      return denominator === 0 ? 0 : numerator / denominator;
    }

    // Function to calculate returns from equity values
    function calculateReturns(equityValues) {
      const returns = [];
      for (let i = 1; i < equityValues.length; i++) {
        if (equityValues[i-1] > 0) {
          returns.push((equityValues[i] - equityValues[i-1]) / equityValues[i-1]);
        }
      }
      return returns;
    }

    async function generateCorrelationAnalysis() {
      try {
        // Get current strategy handle and determine current strategy name
        const productHandle = getProductHandle();
        const currentUrls = handleDataMap[productHandle] || defaultUrls;
        
        // Get all strategy URLs
        const allStrategies = Object.keys(handleDataMap);
        const strategyHandleToName = {
          'weekly-pullback-strategy': 'Weekly Pullback',
          'low-drawdown-nasdaq-mean-reversion-strategy': 'NASDAQ Mean Reversion',
          'all-time-high-mean-reversion-strategy': 'ATH Mean Reversion',
          'etf-rotate-monthly-rebalance-investing-strategy': 'ETF Rotation',
          'mean-reversion-trading-strategy-for-2025': 'New MR 2025',
          'modern-breakout-strategy': 'Breakout Strategy',
          'nasdaq-100-mean-reversion-strategy': 'NASDAQ 100 MR',
          'parabolic-short-selling-strategy': 'Short Selling',
          'short-term-mean-reversion-strategy': 'Short Term MR',
          'spy-mean-reversion': 'SPY Mean Reversion'
        };

        const currentStrategyName = strategyHandleToName[productHandle] || 'New MR 2025';
        
        // All strategy names
        const allStrategyNames = Object.values(strategyHandleToName);

        // Strategy URLs for links
        const strategyUrls = {
          'Weekly Pullback': 'https://sacapitalmanagement.com/products/weekly-pullback-strategy',
          'NASDAQ Mean Reversion': 'https://sacapitalmanagement.com/products/low-drawdown-nasdaq-mean-reversion-strategy',
          'ATH Mean Reversion': 'https://sacapitalmanagement.com/products/all-time-high-mean-reversion-strategy',
          'ETF Rotation': 'https://sacapitalmanagement.com/products/etf-rotate-monthly-rebalance-investing-strategy',
          'New MR 2025': 'https://sacapitalmanagement.com/products/mean-reversion-trading-strategy-for-2025',
          'Breakout Strategy': 'https://sacapitalmanagement.com/products/modern-breakout-strategy',
          'NASDAQ 100 MR': 'https://sacapitalmanagement.com/products/nasdaq-100-mean-reversion-strategy',
          'Short Selling': 'https://sacapitalmanagement.com/products/parabolic-short-selling-strategy',
          'Short Term MR': 'https://sacapitalmanagement.com/products/short-term-mean-reversion-strategy',
          'SPY Mean Reversion': 'https://sacapitalmanagement.com/products/spy-mean-reversion'
        };

        // Fetch all strategy data
        const allData = {};
        const fetchPromises = [];
        
        for (let i = 0; i < allStrategies.length; i++) {
          const strategy = allStrategies[i];
          const strategyName = allStrategyNames[i];
          const url = handleDataMap[strategy].newmrUrl;
          fetchPromises.push(
            fetchJsonOrLog(url, `strategy-${i}`).then(data => {
              allData[strategyName] = data;
            }).catch(error => {
              console.error(`Error fetching ${strategy}:`, error);
              allData[strategyName] = null;
            })
          );
        }

        await Promise.all(fetchPromises);

        // Process data and calculate correlations
        const filterValid = data => data.filter(d => d.Equity && !isNaN(d.Equity));
        
        // Find common dates across all strategies
        let commonDates = null;
        
        for (const [name, data] of Object.entries(allData)) {
          if (data && data.length > 0) {
            const validData = filterValid(data);
            const dates = validData.map(d => d.Date).sort((a, b) => new Date(a) - new Date(b));
            
            if (commonDates === null) {
              commonDates = dates;
            } else {
              commonDates = commonDates.filter(date => dates.includes(date));
            }
          }
        }

        if (!commonDates || commonDates.length < 10) {
          throw new Error('Not enough common dates for correlation analysis');
        }

        // Calculate returns for each strategy
        const strategyReturns = {};
        for (const [name, data] of Object.entries(allData)) {
          if (data && data.length > 0) {
            const validData = filterValid(data);
            const dataMap = new Map(validData.map(d => [d.Date, parseFloat(d.Equity)]));
            const equityValues = commonDates.map(date => dataMap.get(date)).filter(val => val !== undefined);
            
            if (equityValues.length > 1) {
              strategyReturns[name] = calculateReturns(equityValues);
            }
          }
        }

        // Create correlation data for current strategy vs all others
        const otherStrategies = allStrategyNames.filter(name => name !== currentStrategyName);
        const correlationData = [];
        
        if (strategyReturns[currentStrategyName]) {
          for (const otherStrategy of otherStrategies) {
            if (strategyReturns[otherStrategy]) {
              const corr = calculateCorrelation(strategyReturns[currentStrategyName], strategyReturns[otherStrategy]);
              correlationData.push({
                strategy: otherStrategy,
                correlation: corr
              });
            }
          }
        }

        // Create heatmap data for single row
        const heatmapData = [];
        for (let i = 0; i < correlationData.length; i++) {
          heatmapData.push([i, 0, correlationData[i].correlation]);
        }

        document.getElementById('correlationPanel').innerHTML = `
          <div class="correlation-chart-container">
            <div id="correlationChart" style="width: 100%; height: 100%;"></div>
          </div>
        `;

        // Initialize the correlation heatmap
        setTimeout(() => {
          const correlationChartDom = document.getElementById('correlationChart');
          if (correlationChartDom) {
            const correlationChart = echarts.init(correlationChartDom);
            const otherStrategyNames = correlationData.map(d => d.strategy);
            
            correlationChart.setOption({
              title: {
                text: `${currentStrategyName} vs Other Strategies`,
                left: 'center',
                textStyle: {
                  fontSize: 14,
                  color: 'black',
                  fontWeight: 'bold'
                }
              },
              grid: {
                top: 60,
                bottom: 80,
                left: 120,
                right: 20,
                containLabel: true
              },
              tooltip: {
                trigger: 'item',
                formatter: function(params) {
                  return `${currentStrategyName} vs ${otherStrategyNames[params.value[0]]}<br/>Correlation: ${params.value[2].toFixed(3)}`;
                },
                backgroundColor: 'white',
                borderColor: 'gray',
                borderWidth: 1,
                textStyle: {
                  color: 'black',
                  fontSize: 12
                }
              },
              xAxis: {
                type: 'category',
                data: otherStrategyNames,
                axisLabel: {
                  rotate: 45,
                  fontSize: 10,
                  color: '#0066CC'
                },
                axisLine: {
                  lineStyle: {
                    color: 'lightgray'
                  }
                },
                triggerEvent: true
              },
              yAxis: {
                type: 'category',
                data: [currentStrategyName],
                axisLabel: {
                  fontSize: 10,
                  color: 'black',
                  fontWeight: 'bold'
                },
                axisLine: {
                  lineStyle: {
                    color: 'lightgray'
                  }
                }
              },
              visualMap: {
                show: false,
                min: -1,
                max: 1,
                inRange: {
                  color: ['#ff0000', '#ffffff', '#22c55e']
                }
              },
              series: [{
                name: 'Correlation',
                type: 'heatmap',
                data: heatmapData,
                label: {
                  show: true,
                  formatter: function(params) {
                    return params.value[2].toFixed(2);
                  },
                  fontSize: 10,
                  color: 'black',
                  fontWeight: 'bold',
                  position: 'inside',
                  align: 'center',
                  verticalAlign: 'middle'
                },
                emphasis: {
                  disabled: true
                },
                itemStyle: {
                  borderColor: 'white',
                  borderWidth: 1
                }
              }]
            });

            // Add responsive grid adjustments
            function updateGridForScreenSize() {
              const width = window.innerWidth;
              let gridConfig = {
                top: 60,
                bottom: 80,
                left: 120,
                right: 20,
                containLabel: true
              };

              if (width <= 400) {
                // Very small screens
                gridConfig = {
                  top: 50,
                  bottom: 100,
                  left: 100,
                  right: 10,
                  containLabel: true
                };
                correlationChart.setOption({
                  title: {
                    textStyle: { fontSize: 12 }
                  },
                  xAxis: {
                    axisLabel: { fontSize: 8, rotate: 45 }
                  },
                  yAxis: {
                    axisLabel: { fontSize: 8 }
                  },
                  series: [{
                    label: { fontSize: 8 }
                  }]
                });
              } else if (width <= 767) {
                // Mobile screens
                gridConfig = {
                  top: 55,
                  bottom: 90,
                  left: 110,
                  right: 15,
                  containLabel: true
                };
                correlationChart.setOption({
                  title: {
                    textStyle: { fontSize: 13 }
                  },
                  xAxis: {
                    axisLabel: { fontSize: 9, rotate: 45 }
                  },
                  yAxis: {
                    axisLabel: { fontSize: 9 }
                  },
                  series: [{
                    label: { fontSize: 9 }
                  }]
                });
              } else {
                // Desktop screens
                correlationChart.setOption({
                  title: {
                    textStyle: { fontSize: 14 }
                  },
                  xAxis: {
                    axisLabel: { fontSize: 10, rotate: 45 }
                  },
                  yAxis: {
                    axisLabel: { fontSize: 10 }
                  },
                  series: [{
                    label: { fontSize: 10 }
                  }]
                });
              }

              correlationChart.setOption({
                grid: gridConfig
              });
            }

            // Initial grid setup
            updateGridForScreenSize();

            // Update grid on window resize
            window.addEventListener('resize', function() {
              correlationChart.resize();
              updateGridForScreenSize();
            });

            // Add click event for x-axis labels (other strategies)
            correlationChart.on('click', function(params) {
              if (params.componentType === 'xAxis') {
                const strategyName = params.value;
                const url = strategyUrls[strategyName];
                if (url) {
                  window.open(url, '_blank');
                }
              }
            });
          }
        }, 500);

      } catch (error) {
        console.error('Error generating correlation analysis:', error);
        document.getElementById('correlationPanel').innerHTML = `
          <div class="loading">Error loading correlation data between strategies. Please try refreshing the page.</div>
        `;
      }
    }

    async function drawChartAndStats() {
      const { newmrUrl, spyUrl, statsUrl, extendedUrl } = currentUrls;
      try {
        const [newmrData, spyData, stats, extended] = await Promise.all([
          fetchJsonOrLog(newmrUrl, 'newmrUrl'),
          fetchJsonOrLog(spyUrl, 'spyUrl'),
          fetchJsonOrLog(statsUrl, 'statsUrl'),
          fetchJsonOrLog(extendedUrl, 'extendedUrl')
        ]);

        const filterValid = data => data.filter(d => d.Equity && !isNaN(d.Equity));
        const newmrMap = new Map(filterValid(newmrData).map(d => [d.Date, parseFloat(d.Equity)]));
        const spyMap = new Map(filterValid(spyData).map(d => [d.Date, parseFloat(d.Equity)]));
        const allDates = Array.from(new Set([...newmrMap.keys(), ...spyMap.keys()])).sort((a, b) => new Date(a) - new Date(b));
        const newmrEquity = allDates.map(date => newmrMap.get(date) ?? null);
        const spyEquity = allDates.map(date => spyMap.get(date) ?? null);

        const chartDom = document.getElementById('newmrChart');
        const myChart = echarts.init(chartDom);
        
        myChart.setOption({
          title: {
            text: 'Strategy Equity Curve',
            left: 'center'
          },
          color: ['#27ae60', '#e74c3c'],
          tooltip: {
            trigger: 'axis',
            formatter: params => {
              return params.map(p => `${p.seriesName}: $${p.value?.toLocaleString(undefined, { maximumFractionDigits: 2 }) || 'n/a'}`).join('<br/>') +
                     `<br/>Date: ${params[0].axisValue}`;
            }
          },
          legend: {
            top: 30,
            data: ['Strategy', 'SPY Buy & Hold']
          },
          xAxis: {
            type: 'category',
            data: allDates,
            name: 'Year',
            axisLabel: {
              formatter: function (value) {
                if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                  return value.slice(2, 4);
                }
                return value;
              }
            }
          },
          yAxis: {
            type: 'log',
            axisLabel: {
              formatter: val => `$${(val/1000).toFixed(0)}k`
            }
          },
          series: [
            {
              name: 'Strategy',
              type: 'line',
              data: newmrEquity,
              lineStyle: { width: 1.5 },
              symbol: "none"
            },
            {
              name: 'SPY Buy & Hold',
              type: 'line',
              data: spyEquity,
              lineStyle: { width: 1.5 },
              symbol: "none"
            }
          ]
        });

        // Make chart responsive
        window.addEventListener('resize', function() {
          myChart.resize();
        });

        const statPanel = document.getElementById("statsPanel");
        statPanel.innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">Net Profit</div>
              <div class="stat-value">$${stats.NetProfit}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Total Trades</div>
              <div class="stat-value">${stats.Trades}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Sharpe Ratio</div>
              <div class="stat-value">${stats.Sharpe}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">MAR Ratio</div>
              <div class="stat-value">${stats.MAR}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Max Drawdown</div>
              <div class="stat-value">${stats.Drawdown}%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Expectancy per Trade</div>
              <div class="stat-value">${stats.Expectancy}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Win %</div>
              <div class="stat-value">${stats.PctWins}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Max Exposure</div>
              <div class="stat-value">${stats.MaxExposure}</div>
            </div>
          </div>
        `;

        const extendedPanel = document.getElementById("extendedPanel");
        // Show 0 if dividends are 0 or negative, otherwise show original value
        const safeDividends = (extended.sum_dividends <= 0) ? 0 : extended.sum_dividends;
        extendedPanel.innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">Paid Commissions</div>
              <div class="stat-value">$${extended.sum_commission}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Earned Dividends</div>
              <div class="stat-value">$${safeDividends}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Average Holding Days</div>
              <div class="stat-value">${extended.avg_bars}</div>
            </div>
          </div>
        `;

        // Generate monthly performance table
        generateMonthlyTable();

        // Generate correlation analysis
        generateCorrelationAnalysis();

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('statsPanel').innerHTML = `
          <div class="loading">Error loading data. Please try refreshing the page.</div>
        `;
        document.getElementById('extendedPanel').innerHTML = `
          <div class="loading">Error loading data. Please try refreshing the page.</div>
        `;
        document.getElementById('monthlyTablePanel').innerHTML = `
          <div class="loading">Error loading monthly data. Please try refreshing the page.</div>
        `;
        document.getElementById('correlationPanel').innerHTML = `
          <div class="loading">Error loading correlation data. Please try refreshing the page.</div>
        `;
      }
    }

    async function generateMonthlyTable() {
      try {
        // Fetch data from the actual JSON URL
        const monthlyUrl = currentUrls.newmrUrl;
        const response = await fetch(monthlyUrl);
        const rawData = await response.json();

        // Group data by year and month, keep all entries
        const monthlyData = {};
        const validData = rawData.filter(d => d.Date && d.Equity && !isNaN(d.Equity));
        validData.sort((a, b) => new Date(a.Date) - new Date(b.Date));
        validData.forEach(item => {
          const date = new Date(item.Date);
          const year = date.getFullYear();
          const month = date.getMonth();
          if (!monthlyData[year]) monthlyData[year] = {};
          if (!monthlyData[year][month]) monthlyData[year][month] = [];
          monthlyData[year][month].push(parseFloat(item.Equity));
        });

        // Calculate monthly arithmetic returns: (lastEquity - firstEquity) / firstEquity * 100
        const monthlyReturns = {};
        const years = Object.keys(monthlyData).sort();
        years.forEach(year => {
          monthlyReturns[year] = {};
          let yearStartEquity = null;
          let maxDrawdown = 0;
          let peak = 0;
          let lastEquity = null;
          for (let month = 0; month < 12; month++) {
            const equities = monthlyData[year][month];
            if (equities && equities.length > 0) {
              const firstEquity = equities[0];
              const lastEquityMonth = equities[equities.length - 1];
              if (yearStartEquity === null) yearStartEquity = firstEquity;
              // Monthly arithmetic return for this month
              if (firstEquity > 0 && equities.length > 1) {
                monthlyReturns[year][month] = ((lastEquityMonth - firstEquity) / firstEquity) * 100;
              } else {
                monthlyReturns[year][month] = null;
              }
              // For drawdown calculation
              if (peak < lastEquityMonth) peak = lastEquityMonth;
              const drawdown = ((peak - lastEquityMonth) / peak) * 100;
              if (drawdown > maxDrawdown) maxDrawdown = drawdown;
              lastEquity = lastEquityMonth;
            }
          }
          // Calculate annual return (arithmetic)
          if (yearStartEquity !== null && lastEquity !== null) {
            monthlyReturns[year].annual = ((lastEquity - yearStartEquity) / yearStartEquity) * 100;
          }
          monthlyReturns[year].maxDrawdown = maxDrawdown;
        });

        // Calculate averages
        const monthlyAverages = {};
        let totalAnnualReturn = 0;
        let totalMaxDrawdown = 0;
        let validYears = 0;

        for (let month = 0; month < 12; month++) {
          let sum = 0;
          let count = 0;
          years.forEach(year => {
            if (monthlyReturns[year][month] !== undefined && monthlyReturns[year][month] !== null) {
              sum += monthlyReturns[year][month];
              count++;
            }
          });
          monthlyAverages[month] = count > 0 ? sum / count : 0;
        }

        years.forEach(year => {
          if (monthlyReturns[year].annual !== undefined) {
            totalAnnualReturn += monthlyReturns[year].annual;
            totalMaxDrawdown += monthlyReturns[year].maxDrawdown;
            validYears++;
          }
        });

        const avgAnnualReturn = validYears > 0 ? totalAnnualReturn / validYears : 0;
        const avgMaxDrawdown = validYears > 0 ? totalMaxDrawdown / validYears : 0;

        // Generate HTML table with exact styling
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        let tableHTML = `
          <table class="monthly-table">
            <thead>
              <tr>
                <th>YEAR</th>
                ${months.map(month => `<th>${month}</th>`).join('')}
                <th>TOTAL</th>
                <th>MaxDD</th>
              </tr>
            </thead>
            <tbody>
        `;

        // Add data rows
        years.forEach(year => {
          tableHTML += `<tr>`;
          tableHTML += `<td class="year-column"><strong>${year}</strong></td>`;
          
          months.forEach((month, index) => {
            const value = monthlyReturns[year][index];
            let cellClass = '';
            let displayValue = 'n/a';
            
            if (value !== undefined && value !== null && !isNaN(value)) {
              displayValue = `${value.toFixed(2)}%`;
              cellClass = value < 0 ? 'gain-negative' : 'gain-positive';
            }
            
            tableHTML += `<td class="${cellClass}">${displayValue}</td>`;
          });
          
          // Total column
          const totalValue = monthlyReturns[year].annual;
          let totalClass = '';
          let totalDisplay = 'n/a';
          
          if (totalValue !== undefined && totalValue !== null && !isNaN(totalValue)) {
            totalDisplay = `${totalValue.toFixed(2)}%`;
            totalClass = totalValue < 0 ? 'gain-negative' : 'gain-positive';
          }
          
          tableHTML += `<td class="total-column ${totalClass}"><strong>${totalDisplay}</strong></td>`;
          
          // MaxDD column (always black text)
          const maxDDValue = monthlyReturns[year].maxDrawdown;
          let maxDDDisplay = 'n/a';
          if (maxDDValue !== undefined && !isNaN(maxDDValue)) {
            maxDDDisplay = `-${maxDDValue.toFixed(2)}%`;
          }
          tableHTML += `<td class="maxdd-column" style="color:#000;"><strong>${maxDDDisplay}</strong></td>`;
          tableHTML += `</tr>`;
        });

        // Add AVG row
        tableHTML += `<tr class="avg-row">`;
        tableHTML += `<td class="year-column"><strong>AVG</strong></td>`;
        months.forEach((month, index) => {
          const avgValue = monthlyAverages[index];
          const avgDisplay = `${avgValue.toFixed(2)}%`;
          const avgClass = avgValue < 0 ? 'gain-negative' : 'gain-positive';
          tableHTML += `<td class="${avgClass}"><strong>${avgDisplay}</strong></td>`;
        });
        tableHTML += `<td class="total-column"><strong>${avgAnnualReturn.toFixed(2)}%</strong></td>`;
        tableHTML += `<td class="maxdd-column" style="color:#000;"><strong>-${avgMaxDrawdown.toFixed(2)}%</strong></td>`;
        tableHTML += `</tr>`;

        tableHTML += `
            </tbody>
          </table>
        `;

        document.getElementById('monthlyTablePanel').innerHTML = tableHTML;

      } catch (error) {
        console.error('Error generating monthly table:', error);
        document.getElementById('monthlyTablePanel').innerHTML = `
          <div class="loading">Error generating monthly performance table from data source.</div>
        `;
      }
    }

    drawChartAndStats();
  </script>
  <script>
  function sendHeightToParent() {
    const height = document.body.scrollHeight;
    parent.postMessage({ type: 'setIframeHeight', height: height }, '*');
  }

  window.addEventListener('load', sendHeightToParent);
  window.addEventListener('resize', sendHeightToParent);
</script>

</body>
</html>
